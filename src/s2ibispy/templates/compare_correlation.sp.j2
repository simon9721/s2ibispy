* =============================================================================
* IBIS vs SPICE Correlation Deck — {{ model.modelName }}
* Auto-generated by s2ibispy — {{ now }}
* Vcc = {{ "%.3f" % model.voltageRange.typ }}V | Ccomp = {{ "%.3g" % model.c_comp.typ }}F
* Fall time (20-80%) = 0.260ns
* Rise time (20-80%) = 1.073ns
{% if fixture %}
* Fixture load (from golden falling waveform): R = {{ "%.3f" % fixture.R_fixture }}Ω to {{ "%.3f" % fixture.V_fixture }}V
{% endif %}
* =============================================================================

.OPTION PROBE ACCURATE RMAX=0.5
.OPTION POST_VERSION=9601
.OPTION POST=2
.TEMP 50

* === Power Supplies ===
{% if pullup_pin %}
Vsupply {{ pullup_pin.pinName }} 0 DC {{ model.voltageRange.typ }}
{% endif %}
{% if pulldown_pin %}
Vgnd {{ pulldown_pin.pinName }} 0 DC 0
{% endif %}

* === Include Transistor-Level Netlist (auto-wrapped subcircuit) ===
{{ spice_include }}

* === Input Stimulus ===
Vin_spice in_spice 0 PULSE({{ model.voltageRange.typ }} 0 0.1n 1.0p 1.0p 25.0n 50.0n)
Vin_ibis  in_ibis  0 PULSE({{ model.voltageRange.typ }} 0 0.1n 1.0p 1.0p 25.0n 50.0n)

* === Independent OE Control (private nodes) ===
{{ oe_stimuli }}

* =============================================================================
* SPICE Side — 3 Identical Drivers (subcircuit only)
* =============================================================================
* — Using subcircuit: {{ subcircuit_name }}
* Pin order: {{ pin_list|join(' ') }}

{{ x_instances }}

* =============================================================================
* IBIS Side — 3 Identical Drivers (8-node, fully compatible)
* =============================================================================
{% for i in [1,2,3] %}
B{{ i }}IBIS vcc{{ i }}io gnd{{ i }}io out{{ i }}IBIS {% if i != 2 %}in_ibis{% else %}{{ pulldown_pin.pinName }}{% endif %} {{ pullup_pin.pinName }} rcv{{ i }} vcc{{ i }}_clamp gnd{{ i }}_clamp
+ file='{{ ibis_fullpath }}'
+ model='{{ model.modelName }}'
* + buffer=3
+ ramp_rwf=2
+ ramp_fwf=2
+ power=on
R{{ i }} rcv{{ i }} 0 1k
{% if model.c_comp.typ > 0 %}
Ccomp{{ i }} out{{ i }}IBIS 0 {{ "%.3g" % model.c_comp.typ }}
{% endif %}
{% endfor %}

* =============================================================================
* Transmission Lines — 50Ω lossless
* =============================================================================
W_SPICE N=3 out1SPICE out2SPICE out3SPICE 0
+ end1SPICE end2SPICE end3SPICE 0
+ RLGCfile="{{ rlgc_path }}" l=1.2 $ 50 Ohms

W_IBIS N=3 out1IBIS out2IBIS out3IBIS 0
+ end1IBIS end2IBIS end3IBIS 0
+ RLGCfile="{{ rlgc_path }}" l=1.2 $ 50 Ohms

* =============================================================================
* Probe All Critical Nodes
* =============================================================================
.PROBE TRAN
+ V(in_spice) V(in_ibis)
+ V(out1SPICE) V(out1IBIS)
+ V(out2SPICE) V(out2IBIS)
+ V(out3SPICE) V(out3IBIS)
+ V(end1SPICE) V(end1IBIS)
+ V(end2SPICE) V(end2IBIS)
+ V(end3SPICE) V(end3IBIS)

* === Simulation Time ===
.TRAN 5.0ps 50.0ns

.END