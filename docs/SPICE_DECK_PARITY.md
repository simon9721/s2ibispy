# SPICE Deck Parity and Comparison Notes

This document summarizes a pairwise comparison between decks generated by s2ibispy and a commercial reference, and highlights concrete alignment actions. The goal is reproducible parity, focusing first on items that impact results and then cosmetics.

## Executive Summary

- Critical: Our decks instantiate the DUT but drive/measure a different node label. We connect sources/loads/prints to `PAD` while the instantiated DUT pin is `VOUT8`. Without an explicit tie, `PAD` is floating. Fix by wiring to the SPICE node from `[Pin]` mapping (e.g., `VOUT8`) rather than the IBIS pin label (`PAD`).
- Options: Drop `.OPTIONS METHOD=GEAR` and `.OPTIONS GSHUNT`, add `.OPTIONS NUMDGT=8` to match the reference numerics/formatting.
- DC sweeps: Align step rounding (e.g., `0.055`), and for ISSO, align range and step (e.g., `-1.813 1.813 0.037`).
- Transient ramps: Use `5e-12` for time step and rise/fall to match reference.
- Naming and inclusion style differences are cosmetic only.

## Side‑by‑Side Observations

Files inspected: `pdtPAD.spi`, `pdxPAD.spi`, `putPAD.spi`, `rdnPAD.spi`, `runPAD.spi` under `tests/power_out` vs `tests/power_aware_ibis/driver3`.

1) DUT wiring (functional)
- Reference: Instantiates `.inc 'invchain_top.sp'` then drives/loads/prints at `VOUT8`.
- Ours: Include the same netlist (with `XSPI_BUFFER VIN VOUT8 vccq vssq invchain`) but drive/measure `PAD` in loads/prints. No tie exists between `PAD` and `VOUT8` in our files.
- Impact: Invalid/empty coupling to DUT; IV/ISSO/ramp results can be wrong.
- Action: When generating decks, use the SPICE node from `[Pin]` mapping (e.g., `spiceNodeName='VOUT8'`) consistently for loads, sources, and `.PRINT`/`.TRAN` probes. Alternatively instantiate the subckt with `PAD` directly as its output node.

2) Simulator options (numeric stability/formatting)
- Ours: `.OPTIONS LIST NODE POST`, `.OPTIONS METHOD=GEAR`, `.OPTIONS GSHUNT=1E-12`, `.OPTION INGOLD=2`.
- Reference: `.OPTIONS INGOLD=2`, `.OPTIONS NUMDGT=8`.
- Impact: `METHOD=GEAR` and `GSHUNT` can slightly alter numerics; `NUMDGT` is formatting.
- Action: For parity mode, drop `METHOD=GEAR`/`GSHUNT`, add `NUMDGT=8`.

3) DC/ISSO sweep parameters
- IV curves: Ours step = `0.05454545…`; Reference uses `0.055`.
- ISSO: Ours `-1.8 → +1.8 step 0.0545455`; Reference `-1.813 → +1.813 step 0.037`.
- Action: Round IV to `0.055`. For ISSO, match range `±1.813` and step `0.037`.

4) Transient ramps
- Ours: `.TRAN 1.700e-11 1.700e-09` and PULSE edges ~`1.7e-11`.
- Reference: `.TRAN 5.000000e-12 1.700000e-09` and PULSE edges `5e-12`.
- Action: Use `5e-12` step and rise/fall for parity.

5) Temperature formatting and inclusion style
- Ours: `.TEMP 27.0` vs reference `.TEMP 27.000000` — cosmetic only.
- Inclusion: Ours often inlines subckt; reference uses `.inc` — functional equivalence.

6) Node and source naming
- Ours: `VOUTS2I/VCCS2I/VGNDS2I/VINS2I`, node `PAD`.
- Reference: `VOUTT2B/VCCT2B/VGNDT2B/VINT2B`, node `VOUT8`.
- Action: Naming is cosmetic; measurable parity comes from driving/probing the same node.

## Root Cause and Key Mapping

- The `.s2i` file defines pin mapping in `[Pin]`:
  - Example: `PAD  VOUT8  PAD  driver3` → external IBIS pin label `PAD` maps to SPICE node `VOUT8` on the subckt.
- The `.s2i` also declares `[Spice Subckt]  invchain` and `[Spice File]  invchain_top.sp`.
- Current YAML conversion does not preserve `spiceNodeName` (the second `[Pin]` column). Deck generation uses `pin.pinName` (`PAD`) instead of the SPICE node (`VOUT8`) for loads and probes.
- Fix direction:
  1) Preserve `spiceNodeName` in YAML under each component pin; set `IbisPin.spiceNodeName` in the loader.
  2) In deck generation, always call `_pin_node(pin)` when wiring loads, sources, and probes, not `pin.pinName`.
  3) Optionally preserve `[Spice Subckt]` (subckt name) in YAML for cases where a wrapper instance is not present in the SPICE file; then instantiate the subckt explicitly.

## Proposed “Commercial‑Parity” Mode

Add an optional CLI flag to toggle:
- Node wiring: use mapped SPICE node (`spiceNodeName`).
- Options: include `INGOLD=2` and `NUMDGT=8`; omit `METHOD=GEAR` and `GSHUNT`.
- DC steps: IV → `0.055`; ISSO → `-1.813 1.813 0.037`.
- Transient: time step and tr/tf → `5e-12`.
- Naming: optional cosmetic renames for sources if desired.

This mode can be used to validate parity against reference decks without changing default behavior for other flows.

## Next Steps

1) YAML/schema: add `spiceNodeName` for pins and (optionally) `spice_subckt` for components/models; update converter and loader to preserve them from `.s2i`.
2) Deck gen: replace uses of `current_pin.pinName` with `_pin_node(current_pin)` for loads, sweeps, and probes; similarly for wave/ramp.
3) Parity flag: implement option set (steps, options, tr/tf) as a single switch.
4) Re‑generate and compare: validate IV/ISSO/ramp parity across all pairs and produce numeric deltas.
